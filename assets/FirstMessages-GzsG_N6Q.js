const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./VideoWithMuted-BryCN2DG.js","./index-DZEcYG8Q.js","./index-C6k8ZUm0.css","./InfiniteScroll-B9BLyggA.js","./index-BA5m7QhG.js","./MyApp-DRRa55Bd.js","./file-download-pLw6ZM0z.js"])))=>i.map(i=>d[i]);
import{b0 as e,r as t,bi as i,b1 as n,b5 as s,bj as r,aY as a,b2 as o,aW as l,aU as d}from"./index-DZEcYG8Q.js";import{d as c}from"./dayjs.min-BxbhFvXw.js";import{u,a as h,d as g,t as m,j as f,S as v,c as p,T as x,C as j,h as y,i as w,I as b}from"./MyApp-DRRa55Bd.js";import k,{getCacheByKey as M,setCacheByKey as F}from"./useCacheState-D4ghBCVU.js";import{b as N,a as P,s as R,f as I,c as T}from"./messages-CL-8-ijg.js";import{checkVIP as C}from"./useVIP-CGpIDALh.js";import{getUidFromUrl as L}from"./getIds-BE6G2xp0.js";import{S as _}from"./Screen-1_H4V3tg.js";import{I as D}from"./index-B87p3I4c.js";import{D as S}from"./index-B0BghIXV.js";import{L as E}from"./index-CG5dclLJ.js";import{A as O}from"./index-DhxhS065.js";import{I as H}from"./index-BE0FsmaM.js";import"./sweetalert2.esm.all-BZxvatOx.js";import"./index-CiDxWY8X.js";import"./Dropdown-BgvXKd3u.js";import"./col-DLTiGXF3.js";import"./row-BgRGnxnv.js";import"./useBreakpoint-HjQEkdEA.js";import"./Input-LTpJ6AuY.js";import"./EyeOutlined-BBPXKIU8.js";import"./SearchOutlined-Bh66KhXc.js";import"./PurePanel-Beni9Vkb.js";import"./move-Bzyc79vL.js";import"./index-D9U4WvIE.js";import"./List-BPJoeCz4.js";import"./index-CvALG2oX.js";import"./DownOutlined-BrkIPj-I.js";import"./Pagination-Dv2YSLQ3.js";import"./index-C0Edlh-n.js";import"./addEventListener-C9VBchln.js";const Y=o((()=>a((()=>import("./VideoWithMuted-BryCN2DG.js")),__vite__mapDeps([0,1,2]),import.meta.url)),{fallback:b}),B=o((()=>a((()=>import("./InfiniteScroll-B9BLyggA.js")),__vite__mapDeps([3,1,2,4,5]),import.meta.url)),{fallback:j});function V(){var o,l;const{ti:d}=u(),j=e(),{profile:y}=h(),{message:w,notification:b}=g(),O=(null==(o=j.state)?void 0:o.threadId)||"",[H,Y]=k("FirstMessages.friendUrlOrUid."+O,O),[V,A]=k("FirstMessages.friendProfile."+H,null),[W,K]=k("FirstMessages.messages."+H,[]),[z,$]=k("FirstMessages.time."+O,null),[q,X]=t.useState(!1),[G,J]=t.useState({fetchingNext:!1,fetchingPrev:!1,hasNext:!0,hasPrev:!0}),Q=(null==V?void 0:V.name)||(null==(l=j.state)?void 0:l.threadName)||"";t.useEffect((()=>{H&&!(null==W?void 0:W.length)&&re()}),[H,null==W?void 0:W.length]),t.useEffect((()=>{var e,t,i;null==(i=null==(e=ee.current)?void 0:e.scrollTo)||i.call(e,{top:M("FirstMessages.scrollY",(null==(t=ee.current)?void 0:t.scrollHeight)||0)})}),[]);const Z=t.useMemo((()=>{var e,t,i;if(!(null==W?void 0:W.length))return[];const n=[];for(let s=0;s<W.length;s++){let r=null==(e=W[s-1])?void 0:e.sender,a=null==(t=W[s])?void 0:t.sender,o=null==(i=W[s+1])?void 0:i.sender,l="single";a==r&&a==o?l="middle":a==r?l="end":a==o&&(l="start"),n.push({...W[s],position:l})}return n}),[W]),ee=t.useRef(null),te=t.useRef(0),ie=e=>{var t;te.current=(null==(t=ee.current)?void 0:t.scrollHeight)||0,console.log(e),K(e),F("FirstMessages.scrollY",te.current)},ne=t.useRef({prev:!1,next:!1});t.useLayoutEffect((()=>{var e,t,i,n;if(ne.current.prev&&!G.fetchingPrev){ne.current.prev=!1;let i=(null==(e=ee.current)?void 0:e.scrollHeight)||0;i>te.current&&(null==(t=ee.current)||t.scrollTo({top:i-te.current}))}se.current&&(se.current=!1,null==(n=ee.current)||n.scrollTo({top:(null==(i=ee.current)?void 0:i.scrollHeight)||0}))}),[W,G.fetchingPrev]);const se=t.useRef(!1),re=async()=>{var e,t;if(!(null==(t=null==(e=null==H?void 0:H.trim)?void 0:e.call(H))?void 0:t.length))return w.warning({content:d({en:"Please input friend's url/uid first",vi:"Vui lý nhập uid hoặc link bạn bè trước"})});m("FirstMessages:getRecentMessage");const n="getRecentMessage";try{J(i((e=>{e.hasNext=!1,e.hasPrev=!1})));let e=M("FirstMessages.friendProfile."+H);if(!e){let t;if(/\d+$/.test(H)?t=H:(w.loading({key:n,duration:0,content:d({en:"Fetching friend uid...",vi:"Đang tải uid bạn bè..."})}),t=await L(H)),!t)throw new Error("Invalid friend url");w.loading({key:n,duration:0,content:d({en:"Fetching friend info...",vi:"Đang tải thông tin bạn bè"})});try{e=await f(t)}catch(s){}e||(e={uid:t})}A(e),console.log(e),w.loading({key:n,duration:0,content:d({en:"Fetching recent messages...",vi:"Đang tải tin nhắn gần nhất..."})});const t=c();$(t);const r=await N({threadId:e.uid,time:t.valueOf()});ie(r),(null==r?void 0:r.length)>0?w.success({key:n,content:d({en:"Fetch completed",vi:"Tải xong"})}):w.info({key:n,content:d({en:"No data to show",vi:"Không có dữ liệu"})}),se.current=!0,J(i((e=>{e.hasNext=r.length>1,e.hasPrev=!0,e.fetchingNext=!1,e.fetchingPrev=!1})))}catch(s){w.error({key:n,content:d({en:"Failed to fetch",vi:"Lỗi tải"})+": "+s.message})}},ae=async()=>{var e;if(V){m("FirstMessages:fetchNext");try{J(i((e=>{e.fetchingNext=!0})));const t=await T({threadId:null==V?void 0:V.uid,msgId:null==(e=null==W?void 0:W[W.length-1])?void 0:e.id,direction:"down"});console.log(t),t.length>1&&(t.shift(),ie([...W,...t])),ne.current.next=!0,J(i((e=>{e.hasNext=t.length>1})))}catch(t){w.error(d({en:"Failed to fetch",vi:"Lỗi tải"})+": "+t.message)}finally{J(i((e=>{e.fetchingNext=!1})))}}},oe=async()=>{var e;if(V){m("FirstMessages:fetchPrev");try{J(i((e=>{e.fetchingPrev=!0})));const t=await T({threadId:null==V?void 0:V.uid,msgId:null==(e=null==W?void 0:W[0])?void 0:e.id,direction:"up"});t.length>1&&(t.pop(),ie([...t,...W])),ne.current.prev=!0,J(i((e=>{e.hasPrev=t.length>1})))}catch(t){console.error(t),w.error(d({en:"Failed to fetch",vi:"Lỗi tải"})+": "+t.message)}finally{J(i((e=>{e.fetchingPrev=!1})))}}};return n.jsxs(_,{children:[n.jsxs(v,{align:"center",wrap:!0,children:[n.jsx(p.Title,{level:3,children:Q||d({en:"First messages",vi:"Tin nhắn đầu tiên"})}),(null==V?void 0:V.uid)&&n.jsxs(v.Compact,{children:[n.jsx(x,{title:d({en:"Open in Messenger",vi:"Mở trong Messenger"}),children:n.jsx(s,{icon:n.jsx("i",{className:"fa-solid fa-external-link"}),href:"https://www.facebook.com/messages/t/"+(null==V?void 0:V.uid),target:"_blank"})}),n.jsx(x,{title:d({en:"Download all messages",vi:"Tải xuống tất cả tin nhắn"}),children:n.jsx(s,{icon:n.jsx("i",{className:"fa-solid fa-download"}),onClick:async()=>{if(!(await C()))return;const e="FirstMessages:downloadAllMessages";m(e);const t=e+(null==V?void 0:V.uid);w.loading({key:t,duration:0,content:d({en:"Downloading messages...",vi:"Đang tải tin nhắn..."})+Q});let i=!1;const s=await P({threadId:null==V?void 0:V.uid,checkStopFn:()=>i,progressCallback:e=>{w.loading({key:t,duration:0,content:n.jsxs(n.Fragment,{children:[d({en:"Downloading messages... ",vi:"Đang tải tin nhắn... "})+Q,n.jsx("br",{}),e.length,d({en:" messages",vi:" tin nhắn"}),n.jsx("br",{}),c(e[0].time).format("YYYY-MM-DD HH:mm:ss"),n.jsx("br",{}),n.jsx("i",{children:d({en:"Click to stop",vi:"Bấm để dừng"})})]}),onClick:()=>{w.loading({key:t,duration:0,content:d({en:"Stopping...",vi:"Đang dừng..."})}),i=!0}})}});w.destroy(t),b.open({type:"success",duration:0,message:d(i?{en:"Download stopped: ",vi:"Đã dừng tải: "}:{en:"Download completed: ",vi:"Tải xong: "})+Q,description:s.length+d({en:" messages",vi:" tin nhắn"})});const r=R({threadId:(null==V?void 0:V.uid)||"",threadName:Q,myUid:(null==y?void 0:y.uid)||"",msgs:s});(await(await a((async()=>{const{default:e}=await import("./file-download-pLw6ZM0z.js").then((e=>e.f));return{default:e}}),__vite__mapDeps([6,1,2]),import.meta.url)).default)(r,Q+".html")},disabled:!V})})]}),n.jsxs(v.Compact,{children:[n.jsx(x,{title:d({en:"Enter friend url/uid or thread id",vi:"Nhập url/uid của bạn bè/đoạn chat"}),children:n.jsx(D,{value:H,placeholder:d({en:"Enter friend url/uid or thread id",vi:"Nhập url/uid của bạn bè/đoạn chat"}),onChange:e=>Y(e.target.value)})}),n.jsx(s,{type:"primary",onClick:re,loading:q,children:n.jsx("i",{className:"fas fa-search"})}),n.jsx(x,{title:d({vi:"Xem danh sách cuộc trò chuyện chưa mã hoá đầu cuối (e2ee)",en:"View list of not-e2ee conversations"}),children:n.jsx(s,{icon:n.jsx("i",{className:"fa-solid fa-list"}),href:"#/messages/all"})})]}),n.jsxs(v.Compact,{children:[n.jsx(x,{title:d({en:"Choose any date to view messages in that day",vi:"Chọn ngày bất kỳ để xem tin nhắn trong ngày đó"}),children:n.jsx(S,{showTime:!0,value:z,minDate:c(r),onChange:(e,t)=>{console.log("Selected Time: ",e),console.log("Formatted Selected Time: ",t),$(e)},onOk:async e=>{if(!(await C())||!V)return;m("FirstMessages:onSelectDate");let t=c(e).valueOf();const n=await N({threadId:null==V?void 0:V.uid,time:t});console.log(n),ie(n),J(i((e=>{e.hasNext=!0,e.hasPrev=!0})))},disabled:!V,placeholder:d({en:"Select time",vi:"Chọn thời gian"})})}),n.jsx(x,{title:d({en:"Find first message",vi:"Tìm tin nhắn đầu tiên"}),children:n.jsx(s,{type:"primary",onClick:async()=>{if(await C()&&V){m("FirstMessages:getFirstMessage");try{X(!0);const e=await I({threadId:null==V?void 0:V.uid,progress:e=>{$(c(e))}});if(console.log("first message",e),null==e?void 0:e.length){let t=await T({threadId:null==V?void 0:V.uid,msgId:e[0].id});(null==t?void 0:t.length)||(t=await N({threadId:null==V?void 0:V.uid,time:c(Number(e[0].time)).add(1,"day").valueOf()})),console.log(t),t.length?ie(t):w.info(d({en:"No data to show",vi:"Không có dữ liệu"})),J(i((e=>{e.hasNext=!0,e.hasPrev=!0})))}else w.info(d({en:"No data to show",vi:"Không có dữ liệu"}))}catch(e){w.error(d({en:"Failed to fetch",vi:"Lỗi tải"})+": "+e.message),console.log(e)}finally{X(!1)}}},loading:q,disabled:!V,children:n.jsx("i",{className:"fa-solid fa-clock-rotate-left"})})})]})]}),n.jsx(v,{ref:ee,direction:"vertical",size:3,style:{width:"100%",maxHeight:"70vh",overflow:"auto",padding:12},children:(null==Z?void 0:Z.length)?n.jsx(B,{prev:oe,next:ae,hasPrev:G.hasPrev,hasNext:G.hasNext,loader:n.jsx(v,{style:{display:"flex",justifyContent:"center"},children:n.jsx("i",{className:"fa-solid fa-spinner fa-spin fa-lg"})}),endMessage:n.jsx(v,{style:{display:"flex",justifyContent:"center"},children:d({en:"No more message",vi:"Không còn tin nào"})}),children:n.jsx(E,{split:!1,dataSource:Z,renderItem:e=>n.jsx(U,{message:e,myProfile:y})})}):null})]})}function A(e,t){if(t){if("start"===e)return{borderBottomRightRadius:4};if("middle"===e)return{borderBottomRightRadius:4,borderTopRightRadius:4};if("end"===e)return{borderTopRightRadius:4}}else{if("start"===e)return{borderBottomLeftRadius:4};if("middle"===e)return{borderBottomLeftRadius:4,borderTopLeftRadius:4};if("end"===e)return{borderTopLeftRadius:4}}return{}}function U({message:e,myProfile:t}){var i;const s=l(d.darkMode),r=e.position,a=e.sender===(null==t?void 0:t.uid),o={display:"block",wordBreak:"break-word",padding:"8px 12px",backgroundColor:a?"#0184ff":s?"#303030":"#f0f0f0",color:s||a?"#eee":"#111",whiteSpace:"pre-line",margin:0,maxWidth:400,borderTopLeftRadius:24,borderTopRightRadius:24,borderBottomLeftRadius:24,borderBottomRightRadius:24,...A(r,a)},u="end"===r||"single"===r,h=n.jsx("div",{style:{flex:1}});return n.jsxs("div",{style:{display:"flex",alignItems:"center",width:"100%",marginBottom:u?12:2},children:[a?h:u?n.jsx("a",{href:y(e.sender),target:"_blank",children:n.jsx(O,{shape:"circle",size:40,src:w(e.sender),style:{marginRight:8}})}):n.jsx("div",{style:{width:48}}),n.jsxs(x,{title:c(e.time).format("YYYY-MM-DD HH:mm"),placement:a?"left":"right",children:[e.text&&n.jsx(p.Paragraph,{style:o,children:e.text}),e.sticker&&n.jsx(H,{width:150,src:e.sticker}),null==(i=e.attachments)?void 0:i.map(((e,t)=>"video"===e.type?n.jsx(Y,{src:e.uri,style:{maxHeight:300,maxWidth:300}},"attachment"+t):"image"===e.type||"gif"===e.type?n.jsx(H,{src:e.uri,style:{maxHeight:300,maxWidth:300}},"attachment"+t):"file"===e.type?n.jsxs("a",{href:e.uri,target:"_blank",rel:"noreferrer",style:o,children:["File: ",e.filename]},"attachment"+t):null))]}),!a&&h]})}export{V as default};
